<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Mechanical Turk Map Task</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.min.css" rel="stylesheet">
        <style>
            .map { height: 80vh; width: 100%; }
            body { padding-top: 80px; }
        </style>
    </head>
    <body>
        <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="errorModalLabel">Error</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="offcanvas offcanvas-start show" tabindex="-1" id="offcanvas" aria-labelledby="offcanvasLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="offcanvasLabel">Task Instructions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <h2>Draw the elements of a gas station on the map</h2>
                    <p>Please follow the instructions below to complete the task:</p>
                    <ul>
                        <li><strong>Objective:</strong> Your task is to draw polygons around different areas (parcel, convenience store, truck canopy and retail canopy) of the marked gas station or truckstop on the map.</li>
                        <li><strong>Drawing precision:</strong> Use the map's zoom function for better precision in your drawing. Ensure your polygon accurately covers the entire area of interest in each case.</li>
                        <li><strong>Submission:</strong> Once you are satisfied with the polygons you have drawn, submit your work using the 'Submit' button.</li>
                    </ul>
                    <p>If you have any questions or encounter any issues, please refer to the task guidelines or contact support.</p>
                </div>
            </div>
            <nav class="navbar fixed-top bg-body-tertiary">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">Draw the elements of a gas station on the map</a>
                    <form id="mturk-form" class="text-center" method="POST" action="">
                        <input type="hidden" name="assignmentId" id="assignmentId" value="">
                        <input type="hidden" id="geojsonData" name="geojsonData" value="">
                        <button class="btn btn-outline-success" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvas" aria-controls="offcanvas">Instructions</button>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div>
            </nav>
            <div class="row mb-2">
                <div class="col-3">
                    <div class="card">
                        <img src="parcel.png" class="card-img-top" alt="Parcel drawing instructions">
                        <div class="card-body">
                            <h5 class="card-title">Parcel</h5>
                            <p class="card-text"><strong>Draw a polygon around the parcel that contains the gas station.</strong> Make sure to include all accessible areas connected to the gas station. This includes, but is not limited to:</p>
                            <ul>
                                <li>Parking areas</li>
                                <li>Convenience stores</li>
                                <li>Repair shops</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <div class="card-body">
                            <div id="parcel_map" class="map"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-3">
                    <div class="card">
                        <img src="cstore.png" class="card-img-top" alt="Convenience store drawing instructions">
                        <div class="card-body">
                            <h5 class="card-title">Convenience store</h5>
                            <p class="card-text"><strong>Draw a polygon around the convenience store found at the gas station.</strong>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <div class="card-body">
                            <div id="cstore_map" class="map"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-3">
                    <div class="card">
                        <img src="retail.png" class="card-img-top" alt="Retail canopy drawing instructions">
                        <div class="card-body">
                            <h5 class="card-title">Retail canopy</h5>
                            <p class="card-text"><strong>Draw a polygon around the retail canopy found at the gas station.</strong>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <div class="card-body">
                            <div id="retail_map" class="map"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-3">
                    <div class="card">
                        <img src="truck.png" class="card-img-top" alt="Truck canopy drawing instructions">
                        <div class="card-body">
                            <h5 class="card-title">Truck canopy</h5>
                            <p class="card-text"><strong>Draw a polygon around the truck canopy found at the gas station.</strong>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                        <div class="card-body">
                            <div id="truck_map" class="map"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const mapNames = ["parcel", "cstore", "retail", "truck"];

                const urlParams = new URLSearchParams(window.location.search);
                const assignmentId = urlParams.get('assignmentId') || 'SIMULATED_ASSIGNMENT_ID_FOR_TESTING';
                document.getElementById('assignmentId').value = assignmentId;

                const turkSubmitTo = urlParams.get('turkSubmitTo');
                if (turkSubmitTo) {
                    document.getElementById('mturk-form').action = `${turkSubmitTo}/mturk/externalSubmit`;
                }

                const maps = {};
                const geojsons = {};
                for (let mapName of mapNames) {
                    maps[mapName] = L.map(`${mapName}_map`, {
                        center: [parseFloat(urlParams.get('latitude')) || 0, parseFloat(urlParams.get('longitude')) || 0],
                        zoom: parseInt(urlParams.get('zoom'), 10) || 10
                    });

                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                    }).addTo(maps[mapName]);

                    const centerPoint = maps[mapName].getCenter();
                    L.marker(centerPoint).addTo(maps[mapName]);

                    const drawnItems = new L.FeatureGroup();
                    maps[mapName].addLayer(drawnItems);

                    const drawControl = new L.Control.Draw({
                        edit: { featureGroup: drawnItems },
                        draw: {
                            polyline: false,
                            rectangle: false,
                            circle: false,
                            circlemarker: false,
                            polygon: { allowIntersection: false, showArea: true },
                            marker: false,
                        }
                    });
                    maps[mapName].addControl(drawControl);

                    maps[mapName].on(L.Draw.Event.CREATED, function (event) {
                        const layer = event.layer;
                        drawnItems.addLayer(layer);
                        geojsons[mapName] = drawnItems.toGeoJSON();
                    });
                }

                document.getElementById('mturk-form').addEventListener('submit', function(event) {
                    event.preventDefault(); // Prevent form submission
                    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));

                    if (!geojsons["parcel"]) {
                        document.querySelector(".modal-body").innerHTML = "Task is incomplete so it cannot be submitted.";
                        errorModal.show();
                    } else {
                        const geojson = {"type": "FeatureCollection", "features": []};
                        for (let mapName of mapNames) {
                            if (geojsons[mapName] && (geojsons[mapName]["features"].length > 0)) {
                                const feature = geojsons[mapName]["features"][0];
                                feature["id"] = mapName;
                                geojson.features.push(feature);
                            }
                        }
                        document.getElementById('geojsonData').value = JSON.stringify(geojson);
                    }
                });
            });
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    </body>
</html>
