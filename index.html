<!DOCTYPE html>
<html>
<head>
    <title>Mechanical Turk Map Task</title>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.min.css" rel="stylesheet">    
    <style>
        #map { height: 80vh; width: 100%; border: 1px solid #ccc; }
    </style>   
    
    
</head>
<body>
    <div id="map"></div>
    <form id="mturk-form" method="POST" action="">
        <input type="hidden" name="assignmentId" id="assignmentId" value="">
        <input type="hidden" id="geojsonData" name="geojsonData" value="">
        <input type="submit" value="Submit">
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const assignmentId = urlParams.get('assignmentId') || 'SIMULATED_ASSIGNMENT_ID_FOR_TESTING';
            document.getElementById('assignmentId').value = assignmentId;

            // Set the form action to submit directly to MTurk
            const turkSubmitTo = urlParams.get('turkSubmitTo');
            if (turkSubmitTo) {
                document.getElementById('mturk-form').action = `${turkSubmitTo}/mturk/externalSubmit`;
            }

            // Initialize the map with a default view
            const map = L.map('map', {
                center: [parseFloat(urlParams.get('latitude')) || 28.5207551327165, parseFloat(urlParams.get('longitude')) || -82.2339117214042],
                zoom: parseInt(urlParams.get('zoom'), 10) || 18
            });

            // Add a tile layer to the map (GoogelMaps tiles are used here)
            L.tileLayer('http://www.google.cn/maps/vt?lyrs=s@189&gl=cn&x={x}&y={y}&z={z}', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Add a marker at the center of the map
            const centerPoint = map.getCenter();
            L.marker(centerPoint).addTo(map);

            // FeatureGroup is to store editable layers
            const drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            // Add drawing controls to the map with only polygon option enabled
            const drawControl = new L.Control.Draw({
                edit: { featureGroup: drawnItems },
                draw: {
                    polyline: false, // Disable polylines
                    rectangle: false, // Disable rectangles
                    circle: false, // Disable circles
                    circlemarker: false, // Disable circle markers
                    polygon: { allowIntersection: false, showArea: true }, // Enable polygons
                    marker: false, // Disable markers
                }
            });
            map.addControl(drawControl);


            // Event listener for when a new shape is drawn
            map.on(L.Draw.Event.CREATED, function (event) {
                const layer = event.layer;
                drawnItems.addLayer(layer);
                // Update the hidden form field with the GeoJSON data
                document.getElementById('geojsonData').value = JSON.stringify(drawnItems.toGeoJSON());
            });
        });
    </script>
</body>
</html>
